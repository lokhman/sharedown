/*!
 * Sharedown
 *
 * @author  Alexander Lokhman
 * @email   alex.lokhman@gmail.com
 * @link    https://github.com/lokhman/sharedown
 */
(function(a,b){a.Sharedown.Users=new function(){var l=a.Sharedown,g=this;if("Users" in l){return l.Users}var m=b("#modal_user"),n=m.find("form"),j=n.find("#_login"),i=n.find("#_password"),k=n.find('[name="is_enabled"]'),d=n.find('[name="level"]'),e=b(".users-list"),c=b(".users-total"),h=e.find(".users-item").show().detach(),f=e.data("api");this.loadUsers=function(){b.getJSON(f).done(function(r){if(!r.users||!Array.isArray(r.users)){return}e.empty();for(var p=0,o=r.users.length;p<o;p++){var q=r.users[p];h.clone().find(".users-feed").prop("href","/feed/"+q.login).toggle(!!q.has_feed).tooltip().end().find(".users-login").text(function(){if(!q.is_enabled){b(this).wrap("<s>")}return q.login}).end().find(".users-storage").text(q.files+(q.files!==1?" files":" file")).end().find(".users-level").text(q.level).end().find(".users-activity").html(q.activity_at||"&mdash;").end().find(".users-created").text(q.created_at).end().attr("data-login",q.login).appendTo(e)}Sharedown.tooltips()}).always(function(){c.text("Total: "+b(".users-item").length)})};m.on({"show.bs.modal":function(r){var q=b(r.relatedTarget),p=q.closest("[data-login]").data("login"),o=true;if(p){n.prop({action:f+"/"+p,method:"PATCH"}).data("message",'User "'+p+'" details were successfully updated.');i.prop("required",false);o=false}else{n.prop({action:f,method:"POST"}).data("message","User was successfully created.");i.prop("required",true).add(j).val("");d.filter(":first").add(k).prop("checked",true)}l.form_dynamic(n[0],function(){m.modal("hide");g.loadUsers()},o);i.val("")}});e.on("click",".users-delete",function(){var o=b(this).closest(".users-item").data("login");l.modal("Delete","Do you want to delete this user?",function(){b.ajax(f+"/"+o,{type:"DELETE",global:false}).done(g.loadUsers).fail(function(){setTimeout(function(){l.modal("Error","Failed to delete the user from the system.")},500)})})});b(this.loadUsers)}})(window,jQuery);