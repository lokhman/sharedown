/*!
 * Sharedown
 *
 * @author  Alexander Lokhman
 * @email   alex.lokhman@gmail.com
 * @link    https://github.com/lokhman/sharedown
 */
(function(a,b){a.Sharedown.Storage=new function(){var v=a.Sharedown,k=this;if("Storage" in v){return v.Storage}if(typeof a.FileReader==="undefined"){return v.modal("Browser","Your browser is not supported here.")}var h=0,x=[],L=[],p=false,m=b(".drop-zone"),z=b("#modal_edit"),t=z.find("form"),u=b("#_edit_public"),f=b("#_edit_folder"),G=b("#_edit_caption"),D=b("#_edit_password"),j=b("#_edit_permanent"),J=z.find(".modal-title"),q=b("#modal_upload"),E=q.find("form"),r=b("#_upload_public"),c=b("#_upload_folder"),A=b("#_upload_caption"),o=b("#_upload_password"),I=b("#_upload_permanent"),F=q.find(":submit"),s=q.find(".upload-list"),y=s.find(".upload-item").detach(),n=q.find(".upload-progress"),e=n.find(".progress-bar"),K=n.find(".upload-speed"),i=n.find(".upload-size"),g=b(".storage-upload"),M=b(".storage-list"),H=b(".storage-total"),w=M.find(".storage-folder").show().detach(),d=M.find(".storage-item").show().detach(),l=M.find(".storage-empty").detach(),B=M.data("api"),C=v.get_login();this.format=function(N){return(N+"").replace(/(\d)(?=(\d{3})+$)/g,"$1,")};this.size=function(N){if(!N){return"0 bytes"}var O=Math.log(N)/Math.log(1024)|0;return +(N/Math.pow(1024,O)).toFixed(2)+" "+["bytes","KB","MB","GB","TB"][O]};this.time=function(N){return new Date(N).toTimeString().split(" ")[0]};this.serialize=function(N){return N.reduce(function(P,O){if(O.name in P){if(!Array.isArray(P[O.name])){P[O.name]=[P[O.name]]}P[O.name].push(O.value)}else{P[O.name]=O.value}return P},{})};this.random_bytes=function(N){for(var O="";N>0;N-=8){O+=Math.random().toString(36).slice(-Math.min(N,8))}return O};this.hideModalUpload=function(){p=true;q.modal("hide")};this.loadStorage=function(){b.getJSON(B+a.location.search).done(function(O){if(!O.files||!Array.isArray(O.files)){return}M.empty();if(O.files.length===0){return l.appendTo(M)}var N=O.files.reduce(function(R,P){var Q=P.folder||"";if(P.login!==C){Q="{"+P.login+"} "+Q}Q=Q.trim();if(!(Q in R)){R[Q]=[]}R[Q].push(P);return R},{});L.length=0;L.push.apply(L,Object.keys(N).sort());b.each(L,function(P,Q){Q&&w.clone().find("div").html(function(){return Q.replace(/^{([^}]+)}/,'<a href="?login=$1"><mark>$1</mark></a>')}).end().appendTo(M);b.each(N[Q],function(R,S){d.clone().find(".storage-lock").attr("title",S.password?"Password protected":"Unprotected").toggleClass("text-muted-2",!S.password).end().find(".storage-public").attr("title",(S.is_public?"A":"Una")+"vailable in feed").toggleClass("text-muted-2",!S.is_public).end().find(".storage-name").text(S.name).attr({title:S.caption||S.name,href:"/dl/"+S.key}).on("click",function(){if(a.prompt("The URL for sharing:",this.href)!==this.href){return false}}).end().find(".storage-size").text(k.size(S.size)).attr("title",k.format(S.size)+" bytes").end().find(".storage-created").text(S.created_at).attr("title","Expires at: "+(S.expires_at||"(never)")+"<br>Downloaded "+(S.downloads===1?"once":S.downloads+" times")).toggleClass("text-danger",!S.expires_at).tooltip({html:true}).end().find("[title]").tooltip().end().attr("data-key",S.key).appendTo(M)})})}).always(function(){H.text("Total: "+b(".storage-item").length)})};c.add(f).typeahead({source:L});M.on("click",".status-info",function(){var N=b(this).closest(".storage-item").data("key");b.getJSON(B+"/"+N).done(function(O){v.modal(O.name,'<dl class="dl-horizontal"><dt>Key:</dt><dd>'+O.key+"</dd><dt>Name:</dt><dd>"+O.name+'</dd><dt>Size:</dt><dd><abbr title="'+k.format(O.size)+' bytes">'+k.size(O.size)+"</abbr></dd><dt>User:</dt><dd>"+(O.login||"<s>deleted</s>")+"</dd><dt>Folder:</dt><dd>"+(O.folder||"<s>default</s>")+"</dd><dt>Caption:</dt><dd>"+(O.caption||"<s>no caption</s>")+'</dd><dt>Password:</dt><dd class="text-danger">'+(O.password||"<s>no password</s>")+"</dd><dt>Feed status:</dt><dd>"+(O.is_public?"displayed":"hidden")+"</dd><dt>MIME type:</dt><dd>"+O.mimetype+"</dd><dt>Created at:</dt><dd>"+O.created_at+"</dd><dt>Expires at:</dt><dd>"+(O.expires_at||"<s>never</s>")+'</dd><dt>Downloads:</dt><dd style="margin-bottom: 10px;">'+O.downloads+"</dd>"+Object.keys(O.metadata).sort().map(function(P){return"<dt>["+P+"]:</dt><dd>"+O.metadata[P]+"</dd>"}).join("")+"</dl>")})});M.on("click",".storage-delete",function(){var N=b(this).closest(".storage-item").data("key");v.modal("Delete","Do you want to delete this file?",function(){v.ajax_start();b.ajax(B+"/"+N,{type:"DELETE",global:false}).done(k.loadStorage).fail(function(){setTimeout(function(){v.modal("Error","Failed to delete the item from the storage.")},500)}).always(v.ajax_stop)})});q.on({"show.bs.modal":function(){if(!x.length){return}h=0;p=false;s.empty();for(var P=0,N=x.length;P<N;P++){var O=x[P];h+=O.size;y.clone().attr("data-text",O.name+" ["+k.size(O.size)+"]").find(":hidden").val(P).end().appendTo(s)}I.add(r).prop({disabled:false,checked:false});o.prop("disabled",false).val(k.random_bytes(8));A.prop("disabled",x.length!==1).val("");c.prop("disabled",false).val("");F.prop("disabled",false);e.css("width",0);n.hide()},"hide.bs.modal":function(){if(!p){return v.modal("Cancel","Are you sure that you want to cancel the upload?",k.hideModalUpload)}x=[]}});E.on("submit",function(){var R=k.serialize(E.serializeArray()),Q=R["_upload_files[]"],O=k.size(h),P=+new Date(),N=0,S=0,U=[],T=[],V=0;if(!Array.isArray(Q)){Q=[Q]}b.each(Q,function(Z,X){var W=s.children(":has(:hidden[value="+X+"])"),Y=x[X];U.push(b.ajax({type:"PUT",data:Y,url:E.prop("action"),headers:{"X-SF-Name":Y.name,"X-SF-Folder":R._folder,"X-SF-Caption":R._caption,"X-SF-Password":R._password,"X-SF-Permanent":R._permanent,"X-SF-Public":R._public},global:false,processData:false,contentType:false,xhr:function(){var aa=b.ajaxSettings.xhr();aa.upload.onprogress=function(ag){if(p){aa.abort()}if(!ag.lengthComputable){return}var ad=+new Date();if(ad-V<100){return}var ae=S+ag.loaded,ac=ae/h*100;W.addClass("upload");e.css("width",ac+"%").text(Math.round(ac)+"%");i.text(k.size(ae)+" / "+O);if(ac<100){var af=ad-P,ab=af/ae*(h-ae);K.text(k.size(ae/af*1000)+"/s ~ "+k.time(ab))}else{K.text("Processing files, please wait...")}V=ad};return aa}}).done(function(){S+=Y.size;W.removeClass("upload").addClass("done text-success")}).fail(function(){T.push(Y.name);W.removeClass("upload").addClass("error text-danger")}).always(function(){if(++N<U.length||!T.length){return}if(!p){v.modal("Error",'The following files failed to upload:<ul class="text-danger"><li>'+T.join("</li><li>")+"</li></ul>Please try again later.")}k.hideModalUpload();if(T.length<U.length){k.loadStorage()}}))});o.add(r).add(c).add(A).add(I).prop("disabled",true);n.show();b.when.apply(b,U).done(function(){k.hideModalUpload();k.loadStorage()});return false});s.on("click",".close",function(){if(s.children().length>1){b(this.parentNode).remove()}return false});b("html").has(m).on("dragenter",function(){m.show()});m.on({dragover:function(){return false},dragleave:function(){m.hide()},drop:function(N){m.hide();if(x.length){return false}b.when.apply(b,b.map(N.originalEvent.dataTransfer.files,function(P){var Q=b.Deferred(),O;if(P.size===0){Q.resolve()}else{if(P.size<1048576){O=new FileReader();O.onload=function(){x.push(P);Q.resolve()};O.onerror=function(){Q.resolve()};O.readAsDataURL(P)}else{x.push(P);Q.resolve()}}return Q.promise()})).done(function(){x.length&&q.modal()});return false}});g.on("change",function(){x=[];for(var P=0,N=this.files.length;P<N;P++){var O=this.files[P];if(O.size){x.push(O)}}x.length&&q.modal();this.value=""});z.on({"show.bs.modal":function(Q){var P=b(Q.relatedTarget),R=P.closest("[data-key]"),N=R.find(".storage-name").text(),O=R.data("key");t.prop({action:B+"/"+O,method:"PATCH"}).data("message",'File "'+N+'" was successfully updated.');J.text(N);v.form_dynamic(t[0],function(){z.modal("hide");k.loadStorage()})},"hide.bs.modal":function(){D.add(G).add(f).val("").trigger("keyup");j.add(u).prop("checked",false)}});b(this.loadStorage)}})(window,jQuery);