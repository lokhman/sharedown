/*!
 * Sharedown
 *
 * @author  Alexander Lokhman
 * @email   alex.lokhman@gmail.com
 * @link    https://github.com/lokhman/sharedown
 */
(function(a,b){a.Sharedown.Storage=new function(){var s=a.Sharedown,h=this;if("Storage" in s){return s.Storage}if(typeof a.FileReader==="undefined"){return s.modal("Browser","Your browser is not supported here.")}var r=0,i=[],g=false,v=b(".drop-zone"),t=b("#modal_upload"),j=t.find("form"),x=b("#_caption"),y=b("#_password"),d=b("#_permanent"),o=t.find(":submit"),u=t.find(".upload-list"),w=u.find(".upload-item").detach(),e=t.find(".upload-progress"),l=e.find(".progress-bar"),c=e.find(".upload-speed"),n=e.find(".upload-size"),f=b(".storage-upload"),p=b(".storage-list"),z=b(".storage-total"),q=p.find(".storage-item").show().detach(),k=p.find(".storage-empty").detach(),m=p.data("api");this.format=function(A){return(A+"").replace(/(\d)(?=(\d{3})+$)/g,"$1,")};this.size=function(A){if(!A){return"0 bytes"}var B=Math.log(A)/Math.log(1024)|0;return +(A/Math.pow(1024,B)).toFixed(2)+" "+["bytes","KB","MB","GB","TB"][B]};this.time=function(A){return new Date(A).toTimeString().split(" ")[0]};this.serialize=function(A){return A.reduce(function(C,B){if(B.name in C){if(!Array.isArray(C[B.name])){C[B.name]=[C[B.name]]}C[B.name].push(B.value)}else{C[B.name]=B.value}return C},{})};this.random_bytes=function(A){for(var B="";A>0;A-=8){B+=Math.random().toString(36).slice(-Math.min(A,8))}return B};this.hideModalUpload=function(){g=true;t.modal("hide")};this.loadUsers=function(){b.getJSON(m).done(function(D){if(!D.files||!Array.isArray(D.files)){return}p.empty();var A=D.files.length;if(A===0){return k.appendTo(p)}for(var B=0;B<A;B++){var C=D.files[B];q.clone().find(".storage-lock").toggle(!!C.password).tooltip().end().find(".storage-name").text(C.name).prop({title:C.caption||C.name,href:"/dl/"+C.key}).on("click",function(){if(a.prompt("The URL for sharing:",this.href)!==this.href){return false}}).tooltip().end().find(".storage-size").text(h.size(C.size)).prop("title",h.format(C.size)+" bytes").tooltip().end().find(".storage-created").text(C.created_at).prop("title","Expires at: "+(C.expires_at||"(never)")+"<br>Downloaded "+(C.downloads===1?"once":C.downloads+" times")).toggleClass("text-danger",!C.expires_at).tooltip({html:true}).end().attr("data-key",C.key).appendTo(p)}}).always(function(){z.text("Total: "+b(".storage-item").length)})};p.on("click",".status-info",function(){var A=b(this).closest(".storage-item").data("key");b.getJSON(m+"/"+A).done(function(B){s.modal(B.name,'<dl class="dl-horizontal"><dt>Key:</dt><dd>'+B.key+"</dd><dt>Name:</dt><dd>"+B.name+'</dd><dt>Size:</dt><dd><abbr title="'+h.format(B.size)+' bytes">'+h.size(B.size)+"</abbr></dd><dt>Created at:</dt><dd>"+B.created_at+"</dd><dt>Expires at:</dt><dd>"+(B.expires_at||"<i>never</i>")+"</dd><dt>User:</dt><dd>"+(B.login||"<i>deleted</i>")+"</dd><dt>Password:</dt><dd>"+(B.password||"<s>no password</s>")+"</dd><dt>Caption:</dt><dd>"+(B.caption||"<s>no caption</s>")+"</dd><dt>Downloads:</dt><dd>"+B.downloads+"</dd></dl>")})});p.on("click",".storage-delete",function(){var A=b(this).closest(".storage-item").data("key");s.modal("Delete","Do you want to delete this file?",function(){s.ajax_start();b.ajax(m+"/"+A,{type:"DELETE",global:false}).done(h.loadUsers).fail(function(){setTimeout(function(){s.modal("Error","Failed to delete the item from the storage.")},500)}).always(s.ajax_stop)})});t.on({"show.bs.modal":function(){if(!i.length){return}r=0;g=false;u.empty();for(var C=0,A=i.length;C<A;C++){var B=i[C];r+=B.size;w.clone().attr("data-text",B.name+" ["+h.size(B.size)+"]").find(":hidden").val(C).end().appendTo(u)}y.prop("disabled",false).val(h.random_bytes(8));d.prop({disabled:false,checked:false});x.prop("disabled",i.length!==1).val("");o.prop("disabled",false);l.css("width",0);e.hide()},"hide.bs.modal":function(){if(!g){return s.modal("Cancel","Are you sure that you want to cancel the upload?",h.hideModalUpload)}i=[]}});j.on("submit",function(){var E=h.serialize(j.serializeArray()),C=E["_files[]"],A=h.size(r),F=+new Date(),H=0,D=0,G=[],B=[];if(!Array.isArray(C)){C=[C]}b.each(C,function(L,J){var I=u.children(":has(:hidden[value="+J+"])"),K=i[J];G.push(b.ajax({type:"POST",data:K,url:j.prop("action"),headers:{"X-Name":K.name,"X-Caption":E._caption,"X-Password":E._password,"X-Permanent":E._permanent},global:false,processData:false,contentType:false,xhr:function(){var M=b.ajaxSettings.xhr();M.upload.onprogress=function(R){if(g){M.abort()}if(!R.lengthComputable){return}var P=D+R.loaded,Q=+new Date()-F,O=P/r*100,N=Q/P*(r-P);I.addClass("upload");l.css("width",O+"%").text(Math.round(O)+"%");c.text(h.size(P/Q*1000)+"/s ~ "+h.time(N));n.text(h.size(P)+" / "+A)};return M}}).done(function(){D+=K.size;I.removeClass("upload").addClass("done text-success")}).fail(function(){B.push(K.name);I.removeClass("upload").addClass("error text-danger")}).always(function(){if(++H<G.length||!B.length){return}if(!g){s.modal("Error",'The following files failed to upload:<ul class="text-danger"><li>'+B.join("</li><li>")+"</li></ul>Please try again later.")}h.hideModalUpload()}))});y.add(x).add(d).prop("disabled",true);e.show();b.when.apply(b,G).done(function(){h.hideModalUpload();h.loadUsers()});return false});u.on("click",".close",function(){if(u.children().length>1){b(this.parentNode).remove()}return false});b("html").has(v).on("dragenter",function(){v.show()});v.on({dragover:function(){return false},dragleave:function(){v.hide()},drop:function(A){v.hide();if(i.length){return false}b.when.apply(b,b.map(A.originalEvent.dataTransfer.files,function(C){var D=b.Deferred(),B;if(C.size===0){D.resolve()}else{if(C.size<1048576){B=new FileReader();B.onload=function(){i.push(C);D.resolve()};B.onerror=function(){D.resolve()};B.readAsDataURL(C)}else{i.push(C);D.resolve()}}return D.promise()})).done(function(){i.length&&t.modal()});return false}});f.on("change",function(){i=[];for(var C=0,A=this.files.length;C<A;C++){var B=this.files[C];if(B.size){i.push(B)}}i.length&&t.modal();this.value=""});b(this.loadUsers)}})(window,jQuery);